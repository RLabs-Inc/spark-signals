# Codebase Structure

**Analysis Date:** 2026-01-23

## Directory Layout

```
spark-signals/
├── src/                    # Source code (currently minimal, to be expanded)
│   └── lib.rs             # Crate root (intentionally empty for GSD)
├── benches/               # Performance benchmarks
│   └── signals.rs         # Criterion benchmarks showing expected API
├── Cargo.toml             # Package manifest
├── CLAUDE.md              # Project context and constraints
├── .planning/             # GSD planning documents
│   └── codebase/          # This directory
├── .git/                  # Version control
└── target/                # Build artifacts (generated)
```

## Directory Purposes

**`src/`:**
- Purpose: Rust source code implementation
- Contains: lib.rs only (to be filled with modular structure)
- Key files: `lib.rs` (main crate entry point)
- Notes: Structure TBD, expected to mirror TypeScript layout with core/, reactivity/, primitives/, collections/

**`benches/`:**
- Purpose: Performance benchmarks and API contract specification
- Contains: Criterion benchmark suites
- Key files: `signals.rs` (13 benchmark groups showing expected API)
- Notes: Benchmarks currently import from spark_signals, defining what public API must exist

**`.planning/`:**
- Purpose: GSD project planning and analysis documents
- Contains: PROGRESS.md, ARCHITECTURE.md, STRUCTURE.md, etc.
- Key files: Generated by GSD orchestrator

**`target/`:**
- Purpose: Build artifacts and compiled output
- Generated: Yes (by `cargo build`)
- Committed: No (.gitignore)

## Key File Locations

**Entry Points:**
- `src/lib.rs`: Crate root - will export public API (signal, derived, effect, batch, etc.)

**Configuration:**
- `Cargo.toml`: Package metadata, dependencies, features, benchmark definition
- `.claude.md`: Project constraints (CLAUDE.md - not standard, but project-specific)

**Core Logic (to be implemented):**
- `src/core/mod.rs`: (TBD) Core types and constants
- `src/core/constants.rs`: (TBD) Bitmask flags, sentinel values
- `src/core/types.rs`: (TBD) Signal, Source, Reaction, Derived, Effect trait definitions
- `src/core/globals.rs`: (TBD) Thread-local/global mutable state

**Reactivity Engine (to be implemented):**
- `src/reactivity/tracking.rs`: (TBD) get() and set() core functions, dependency tracking
- `src/reactivity/scheduling.rs`: (TBD) Effect scheduler, flushSync()
- `src/reactivity/batching.rs`: (TBD) batch(), untrack(), peek()
- `src/reactivity/equality.rs`: (TBD) Equality comparison functions

**Primitives (to be implemented):**
- `src/primitives/signal.rs`: (TBD) signal(), source() - writable reactive values
- `src/primitives/derived.rs`: (TBD) derived() - lazy computed values
- `src/primitives/effect.rs`: (TBD) effect(), effect.sync() - side effects
- `src/primitives/bind.rs`: (TBD) bind(), bindReadonly() - two-way bindings
- `src/primitives/linked.rs`: (TBD) linkedSignal() - external sync
- `src/primitives/selector.rs`: (TBD) createSelector()
- `src/primitives/scope.rs`: (TBD) effectScope()
- `src/primitives/slot.rs`: (TBD) slot(), slotArray()
- `src/primitives/props.rs`: (TBD) reactiveProps()

**Collections (to be implemented):**
- `src/collections/map.rs`: (TBD) ReactiveMap<K, V>
- `src/collections/set.rs`: (TBD) ReactiveSet<T>
- `src/collections/vec.rs`: (TBD) ReactiveVec<T> (Rust addition)

**Testing:**
- `benches/signals.rs`: Criterion benchmarks (existing, comprehensive)
- Tests (TBD): Unit tests, integration tests (not yet created)

## Naming Conventions

**Files:**
- Module files: `module_name.rs` (snake_case)
- Entry file: `lib.rs` (root), `mod.rs` (module directories)
- Test files: (TBD) `module_name.rs` with `#[cfg(test)]` or separate `tests/` directory

**Directories:**
- Module folders: `module_name/` (snake_case, matches module name)
- Collection: `core/`, `reactivity/`, `primitives/`, `collections/`

**Functions:**
- Public API: `camelCase` in Rust (e.g., `signal()`, `derived()`, but Rust convention is `snake_case`)
- Actual pattern: Follow TypeScript exactly - `signal`, `derived`, `effect`, `batch` (no underscores, matches TS)
- Internal helpers: `snake_case` with leading `_` if private (e.g., `_update_derived_chain`)

**Types/Interfaces:**
- Trait names: `PascalCase` (e.g., `Signal`, `Source`, `Reaction`, `Derived`, `Effect`)
- Enum names: `PascalCase`
- Struct names: `PascalCase`
- Type aliases: `PascalCase`

**Constants:**
- Flag constants: `SCREAMING_SNAKE_CASE` (e.g., `DIRTY`, `CLEAN`, `MAYBE_DIRTY`, `DERIVED`, `EFFECT`)
- Sentinel values: `SCREAMING_SNAKE_CASE` (e.g., `UNINITIALIZED`, `STALE_REACTION`)

## Where to Add New Code

**New Feature (Primitive):**
- Primary code: `src/primitives/feature_name.rs`
- Tests: `src/primitives/feature_name.rs` with `#[cfg(test)] mod tests { ... }`
- Export from: `src/lib.rs` as `pub use crate::primitives::feature_name::*;`
- Example: Adding `slot()` would go in `src/primitives/slot.rs`

**New Collection Type:**
- Implementation: `src/collections/collection_type.rs`
- Tests: In same file with `#[cfg(test)]` or separate `tests/` directory
- Export from: `src/lib.rs` as `pub use crate::collections::collection_type::*;`
- Example: `ReactiveVec<T>` would go in `src/collections/vec.rs`

**Utilities / Helpers:**
- Shared helpers: `src/utils/` (if created) or within module where primarily used
- Equality functions: `src/reactivity/equality.rs`
- Global state accessors: `src/core/globals.rs`

**Unit Tests:**
- Location: Same file as implementation, in `#[cfg(test)] mod tests { ... }` block
- Pattern: Test private functions with `#[test] fn test_name() { ... }`
- Convention: Name tests descriptively (test_get_with_active_reaction, test_set_same_value_skips_update)

**Integration Tests:**
- Location: (TBD) Either in `tests/` directory or multipart benchmarks
- Pattern: Full workflows testing signal → derived → effect chains
- Example: benches/signals.rs already contains integration-level tests

## Special Directories

**`target/`:**
- Purpose: Cargo build output
- Generated: Yes (by `cargo build`, `cargo bench`)
- Committed: No (in .gitignore)
- Contents: debug/, release/, criterion reports, etc.

**`.planning/`:**
- Purpose: GSD project planning
- Generated: Yes (by GSD tools)
- Committed: Yes (part of project repo)
- Contents: Phase definitions, analysis documents, PROGRESS.md

**`.git/`:**
- Purpose: Version control
- Generated: Yes (git)
- Committed: N/A (internal git data)

## Module Organization Pattern

Expected structure following TypeScript layout:

```rust
// src/lib.rs
mod core;
mod reactivity;
mod primitives;
mod collections;

pub use core::{types::*, constants::*};
pub use reactivity::{tracking::{get, set}, batching::{batch, untrack, peek}};
pub use primitives::{
    signal::{signal, source},
    derived::derived,
    effect::effect,
    // ... etc
};
pub use collections::{ReactiveMap, ReactiveSet};
```

Each module has:
- `mod.rs` (or inline in file) declaring submodules
- Internal module organization matching TypeScript structure
- Public exports at module level via `pub use`

## Cargo Configuration

**Features:**
- `default`: No features (minimal)
- `sync`: (defined) Enables thread-safe variants using Arc<RwLock<T>> instead of Rc<RefCell<T>>

**Dependencies:**
- None in main library (intentionally minimal)
- Dev-dependencies: `criterion` for benchmarking

**Bench Target:**
- `benches/signals.rs` with harness=false (Criterion manages it)
- Run: `cargo bench`

---

*Structure analysis: 2026-01-23*
